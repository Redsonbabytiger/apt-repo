name: Update APT Repository

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  repository_dispatch:
    types: [ "release-update" ]
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directory structure
        run: |
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p pool/main

      - name: Move .deb packages to pool if needed
        run: |
          # Automatically move any .deb files dropped in the repo root
          for f in *.deb; do
            if [ -f "$f" ]; then
              echo "Found .deb file: $f â€” moving to pool/main/"
              mv "$f" pool/main/
            fi
          done

      - name: Generate Packages file
        run: |
          echo "Generating Packages file..."
          dpkg-scanpackages pool/main /dev/null > dists/stable/main/binary-amd64/Packages

      - name: Compress Packages.gz
        run: |
          echo "Compressing Packages.gz..."
          gzip -fk dists/stable/main/binary-amd64/Packages

      - name: Generate Release file
        run: |
          echo "Generating Release file..."

          RELEASE_FILE="dists/stable/Release"

          cat > $RELEASE_FILE <<EOF
Origin: Redsonbabytiger
Label: Redsonbabytiger APT Repo
Suite: stable
Codename: stable
Date: $(date -Ru)
Architectures: amd64
Components: main
Description: APT repository for Redsonbabytiger projects
MD5Sum:
EOF

          # Add MD5
          find dists/stable -type f ! -name Release | sed 's/^dists\/stable\///' | while read file; do
            md5=$(md5sum dists/stable/$file | awk '{print $1}')
            size=$(stat -c%s dists/stable/$file)
            printf " %s %d %s\n" "$md5" "$size" "$file" >> $RELEASE_FILE
          done

          cat >> $RELEASE_FILE <<EOF
SHA1:
EOF

          # Add SHA1
          find dists/stable -type f ! -name Release | sed 's/^dists\/stable\///' | while read file; do
            sha1=$(sha1sum dists/stable/$file | awk '{print $1}')
            size=$(stat -c%s dists/stable/$file)
            printf " %s %d %s\n" "$sha1" "$size" "$file" >> $RELEASE_FILE
          done

          cat >> $RELEASE_FILE <<EOF
SHA256:
EOF

          # Add SHA256
          find dists/stable -type f ! -name Release | sed 's/^dists\/stable\///' | while read file; do
            sha256=$(sha256sum dists/stable/$file | awk '{print $1}')
            size=$(stat -c%s dists/stable/$file)
            printf " %s %d %s\n" "$sha256" "$size" "$file" >> $RELEASE_FILE
          done

      - name: Final file check
        run: |
          echo "===== Directory Tree ====="
          tree -a .

          echo "===== Contents of Packages ====="
          cat dists/stable/main/binary-amd64/Packages

          echo "===== Contents of Release ====="
          cat dists/stable/Release

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Automated repo update"
            git push
          fi
